# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

PPTAgent is an AI-powered system that automatically generates PowerPoint presentations from documents using a two-phase approach:
1. **Stage I (Analysis)**: `induct.py` - Analyzes reference presentations to extract layouts, content schemas, and design patterns
2. **Stage II (Generation)**: `pptgen.py` - Generates new presentations by creating outlines and populating slides with content

The system uses LLM agents (defined in `agent.py`) that collaborate through role-based prompts (in `roles/` directory) to perform tasks like layout selection, content organization, and code generation.

## Development Commands

### Setup and Installation
```bash
# Install with full dependencies (includes ML models)
pip install -e ".[full]"

# Install base version only
pip install -e .

# Install custom python-pptx fork (REQUIRED)
pip install python-pptx@git+https://github.com/Force1ess/python-pptx@219513d7d81a61961fc541578c1857d08b43aa2a
```

### Testing
```bash
# Run all tests
pytest

# Run tests in parallel
pytest -n auto

# Run specific test file
pytest test/test_pptgen.py

# Run tests with specific markers
pytest -m llm          # Tests requiring OPENAI_API_KEY
pytest -m parse        # Tests requiring MinerU API
pytest -m asyncio      # Async tests

# Skip LLM/API tests
pytest -m "not llm and not parse"
```

### Code Quality
```bash
# Format code (via pre-commit)
ruff check --fix .
ruff format .

# Run pre-commit hooks
pre-commit run --all-files
```

### Running the Application

#### Backend Server (WebUI)
```bash
# Set required environment variables
export OPENAI_API_KEY="your_key"
export API_BASE="http://your_service_provider/v1"
export LANGUAGE_MODEL="openai/gpt-4.1"
export VISION_MODEL="openai/gpt-4.1"
export MINERU_API="http://localhost:8000/file_parse"  # Optional PDF parsing

# Start backend
python pptagent_ui/backend.py
```

#### Frontend (WebUI)
```bash
cd pptagent_ui
npm install
npm run serve
```

#### MCP Server (stdio)
```bash
export PPTAGENT_MODEL=openai/gpt-4.1
export PPTAGENT_API_BASE=http://localhost:8000/v1
export PPTAGENT_API_KEY=your_key
export PPTAGENT_VISION_MODEL=openai/gpt-4.1  # Optional, defaults to PPTAGENT_MODEL if not set
uv run pptagent-mcp
```

## Architecture

### Core Module Structure

- **`pptagent/`**: Main package containing all core functionality
  - **`presentation/`**: PowerPoint file parsing and manipulation
    - `presentation.py`: `Presentation` class - represents entire PPTX files
    - `shapes.py`: Shape classes (`TextBox`, `Picture`, `GroupShape`, etc.)
    - `layout.py`: `Layout` class - manages slide layouts and content schemas

  - **`document/`**: Document parsing and organization
    - `document.py`: `Document` class - represents source documents (markdown/PDF)
    - `element.py`: Document element types (paragraphs, sections, images)

  - **`response/`**: Pydantic models for LLM structured outputs
    - `outline.py`: `Outline`, `OutlineItem` - presentation structure
    - `pptgen.py`: `EditorOutput`, `LayoutChoice` - slide generation responses
    - `induct.py`: `SlideSchema` - layout content schemas

  - **Core modules**:
    - `pptgen.py`: `PPTAgent` class - orchestrates presentation generation
    - `induct.py`: `SlideInducter` class - analyzes reference presentations
    - `agent.py`: `Agent` class - wraps LLMs with role-based prompts
    - `llms.py`: `AsyncLLM` class - async LLM API wrapper
    - `apis.py`: `CodeExecutor` - executes slide editing commands
    - `mcp_server.py`: `PPTAgentServer` - MCP protocol server

  - **Supporting modules**:
    - `utils.py`: Config, logging, language detection utilities
    - `model_utils.py`: `ModelManager` - handles image/language models
    - `multimodal.py`: `ImageLabler` - image processing utilities
    - `ppteval.py`: Presentation evaluation metrics

- **`pptagent_ui/`**: Web interface (Vue.js frontend + FastAPI backend)
- **`test/`**: Test suite using pytest
- **`runs/`**: Example presentations and documents for testing
- **`roles/`**: YAML configs defining agent prompts and behaviors
- **`prompts/`**: Jinja2 templates for LLM prompts

### Key Design Patterns

1. **Agent-Based Architecture**: Each task (planning, layout selection, content editing) is handled by a specialized `Agent` with its own prompt template and LLM configuration (see `roles/*.yaml`)

2. **Two-Phase Pipeline**:
   - Phase 1 (`SlideInducter`): Cluster slides by visual similarity → extract content schemas
   - Phase 2 (`PPTAgent`): Generate outline → select layouts → fill content → execute edits

3. **Code Execution Model**: `CodeExecutor` validates and executes editing commands on slide templates using APIs defined in `apis.py`. Commands are generated by the "coder" agent and represent structural changes (add/remove paragraphs, images, etc.)

4. **Async/Concurrent Processing**: Heavy use of `asyncio` for parallel slide generation and LLM calls. Use `aiometer.run_all()` for rate-limited concurrent operations.

5. **Custom python-pptx**: Requires a forked version with extended capabilities (see installation). Check for version assertion in `__init__.py:21`.

### Important Implementation Details

- **Layout Types**: Layouts are classified as "text" (`:text` suffix) or "image" (`:image` suffix). Functional layouts (opening, TOC, section header, ending) are handled specially via `FunctionalLayouts` enum.

- **Content Schema**: Each layout has a `content_schema` extracted during analysis that describes expected content structure (text fields, image placeholders, etc.). See `presentation/layout.py:Layout.validate()`.

- **Length Factor**: Controls text length in generated slides relative to reference slides. Auto-calculated based on source/target language families (Latin vs CJK). See `pptgen.py:get_length_factor()`.

- **Image Retrieval**: Uses simple similarity-based retrieval from source document. Images are matched to slides during outline generation. Not network-based.

- **Error Handling**: Retry mechanism for LLM failures (default 3 retries). Set `error_exit=True` to stop on first failure instead of skipping failed slides.

## Testing Guidelines

- `conftest.py` defines `TestConfig` class with shared test fixtures
- Test data located in `runs/` directory (reference presentations and documents)
- Tests marked with `@pytest.mark.llm` require `OPENAI_API_KEY` environment variable
- Tests marked with `@pytest.mark.parse` require MinerU API running
- Use `pytest -n auto` for parallel test execution (faster)
- Warning filters configured to treat zipfile warnings as errors (indicates save failures)

## Configuration and Environment

### Required Environment Variables
- `OPENAI_API_KEY`: OpenAI API key or compatible API key
- `API_BASE`: Base URL for LLM API (defaults to OpenAI)
- `LANGUAGE_MODEL`: Model identifier for text generation (e.g., "openai/gpt-4.1")
- `VISION_MODEL`: Model identifier for vision tasks (e.g., "openai/gpt-4.1")

### Optional Environment Variables
- `MINERU_API`: PDF parsing API endpoint (for document upload feature)
- `PPTAGENT_LENGTH_FACTOR`: Override auto-calculated length factor
- `PPTAGENT_AUTO_LENGTH_FACTOR`: Enable/disable automatic length factor calculation
- `PPTAGENT_VISION_MODEL`: Vision model for MCP server (defaults to PPTAGENT_MODEL if not set)

### System Requirements
- **Python**: 3.11+ (enforced in pyproject.toml)
- **OS**: Linux/macOS (Windows not supported)
- **External dependencies**: LibreOffice, Chrome, poppler-utils, NodeJS
- **GPU**: Optional but recommended for faster image processing (CUDA or MPS)

## Key Files to Reference

- `test/test_pptgen.py`: Example of end-to-end presentation generation
- `pptagent_ui/backend.py`: API endpoint examples and generation workflow
- `BESTPRACTICE.md`: Guidelines for preparing reference presentations
- `DOC.md`: User-facing documentation with detailed setup instructions
- `.pre-commit-config.yaml`: Code style enforcement (ruff, pyupgrade)

## Common Pitfalls

1. **Missing custom python-pptx**: The project will not work with standard python-pptx. Always install the custom fork.

2. **Async context**: Most core functions are async. Use `await` and run in async context (`asyncio.run()` or within async test functions).

3. **Slide indexing**: Slides are 1-indexed in `SlideInducter` results but 0-indexed in `Presentation.slides` list. Be careful when converting.

4. **Image paths**: All image paths in `Document` must be validated before generation via `Document.validate_medias(image_dir)`.

5. **Layout schema validation**: Content must match layout schema. The `editor` agent output is validated against allowed images and element types before execution.

6. **Model requirements**: Language models need 70B+ parameters (or GPT-4 level). Smaller models may produce invalid structured outputs.
